import urllib.parse
from datetime import datetime

import streamlit as st

# src/utils.py (è¿½åŠ åœ¨æ–‡ä»¶æœ«å°¾æˆ–åˆé€‚ä½ç½®)
from google import genai

# src/utils.py


@st.cache_resource
def get_available_models(api_key):
    """
    æ£€æŸ¥å¯ç”¨æ¨¡å‹å¹¶æ ¹æ®æ€§èƒ½åˆ†ç±»ã€‚
    ä¼˜å…ˆä½¿ç”¨ Gemini 3 ç³»åˆ— (æ ¹æ®ä½ çš„ check_models ç»“æœå®šåˆ¶)
    """
    # é»˜è®¤å…œåº•
    default_models = {
        "ğŸš€ Fast (Gemini 1.5 Flash)": "gemini-1.5-flash",
        "âš–ï¸ Balanced (Gemini 1.5 Pro)": "gemini-1.5-pro",
    }

    try:
        client = genai.Client(api_key=api_key)
        all_models = list(client.models.list())
        # æå–çº¯å‡€çš„æ¨¡å‹å (å»æ‰ models/ å‰ç¼€)
        model_names = [m.name.replace("models/", "") for m in all_models]

        found_models = {}

        # --- 1. ğŸš€ Fast: è¿½æ±‚é€Ÿåº¦ä¸æ€§ä»·æ¯” ---
        # ä¼˜å…ˆç”¨ Gemini 3 Flash Preview (å…¼é¡¾é€Ÿåº¦ä¸æ™ºå•†)
        if "gemini-3-flash-preview" in model_names:
            found_models["ğŸš€ Fast (Gemini 3 Flash)"] = "gemini-3-flash-preview"
        elif "gemini-2.0-flash" in model_names:
            found_models["ğŸš€ Fast (Gemini 2.0 Flash)"] = "gemini-2.0-flash"
        elif "gemini-1.5-flash" in model_names:
            found_models["ğŸš€ Fast (Gemini 1.5 Flash)"] = "gemini-1.5-flash"

        # --- 2. ğŸ§  Smart: è¿½æ±‚æœ€å¼ºæ¨ç† (å¤„ç† 5/24 æˆ–å¤æ‚åˆ†æ) ---
        # ä¼˜å…ˆç”¨ Gemini 3 Pro Preview
        if "gemini-3-pro-preview" in model_names:
            found_models["ğŸ§  Smart (Gemini 3 Pro)"] = "gemini-3-pro-preview"
        elif "gemini-2.0-pro-exp" in model_names:  # å‡å¦‚æœªæ¥æœ‰
            found_models["ğŸ§  Smart (Gemini 2.0 Pro)"] = "gemini-2.0-pro-exp"
        elif "gemini-1.5-pro" in model_names:
            found_models["ğŸ§  Smart (Gemini 1.5 Pro)"] = "gemini-1.5-pro"

        # --- 3. âš¡ï¸ Experimental: å°é²œ Google æœ€æ–°é»‘ç§‘æŠ€ ---
        # æ¯”å¦‚ 2.0 Flash Exp æˆ– Thinking æ¨¡å¼
        if "gemini-2.0-flash-thinking-exp" in model_names:
            found_models["âš¡ï¸ Thinking (Gemini 2.0 Exp)"] = (
                "gemini-2.0-flash-thinking-exp"
            )
        elif "gemini-2.0-flash-exp" in model_names:
            found_models["âš¡ï¸ Experimental (Gemini 2.0 Flash)"] = "gemini-2.0-flash-exp"

        if not found_models:
            return default_models

        # æ’åºï¼šFast -> Smart -> Experimental
        # ä½¿ç”¨è‡ªå®šä¹‰é¡ºåºï¼Œè€Œä¸æ˜¯å­—æ¯é¡ºåº
        order = ["ğŸš€", "ğŸ§ ", "âš¡ï¸", "âš–ï¸"]
        sorted_keys = sorted(
            found_models.keys(),
            key=lambda x: next((i for i, k in enumerate(order) if k in x), 99),
        )

        return {k: found_models[k] for k in sorted_keys}

    except Exception as e:
        print(f"Model check failed: {e}")
        return default_models


def create_google_calendar_url(title, description, date_str):
    """ç”Ÿæˆ Google Calendar æ·»åŠ é“¾æ¥"""
    # é»˜è®¤è®¾ä¸ºå½“å¤©å…¨å¤©äº‹ä»¶ï¼Œæˆ–è€…è®¾ä¸ºä¸Šåˆ 9 ç‚¹æé†’
    try:
        dt = datetime.strptime(date_str, "%Y-%m-%d")
        # æ ¼å¼: YYYYMMDDT090000Z
        start_time = dt.strftime("%Y%m%dT090000")
        end_time = dt.strftime("%Y%m%dT100000")
    except:
        return "#"

    base_url = "https://calendar.google.com/calendar/render"
    params = {
        "action": "TEMPLATE",
        "text": f"{title}",
        "details": f"{description}\n\nGenerated by Walle AI.",
        "dates": f"{start_time}/{end_time}",
    }
    return f"{base_url}?{urllib.parse.urlencode(params)}"


def create_ics_file_content(title, description, date_str):
    """ç”Ÿæˆ .ics æ–‡ä»¶å†…å®¹ (é€‚é… Apple / Outlook)"""
    try:
        dt = datetime.strptime(date_str, "%Y-%m-%d")
        dt_str = dt.strftime("%Y%m%d")
    except:
        dt_str = datetime.now().strftime("%Y%m%d")

    # ICS æ ‡å‡†æ ¼å¼
    ics_content = f"""BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Walle AI//Credit Card Agent//EN
BEGIN:VEVENT
SUMMARY:{title}
DTSTART;VALUE=DATE:{dt_str}
DTEND;VALUE=DATE:{dt_str}
DESCRIPTION:{description}
STATUS:CONFIRMED
SEQUENCE:0
BEGIN:VALARM
TRIGGER:-PT9H
DESCRIPTION:Reminder
ACTION:DISPLAY
END:VALARM
END:VEVENT
END:VCALENDAR"""
    return ics_content
